<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Function Graph & Tree</title>
    <style>
        body {
            margin: 0;
            padding: 0;
            overflow: hidden;
            background: black;
            height: 100vh;
            display: grid;
            grid-template-rows: 50vh 35vh 15vh;
        }
        #top-pane {
            position: relative;
            width: 100%;
            height: 100%;
            overflow: hidden;
        }
        canvas {
            display: block;
            width: 100%;
            height: 100%;
        }
        #tree-pane {
            width: 100%;
            height: 100%;
            background: #1e1e1e;
            border-top: 1px solid #444;
        }
        #code-pane {
            width: 100%;
            height: 100%;
            background: #111;
            color: #6ad76a;
            padding: 10px;
            box-sizing: border-box;
            font-family: 'Consolas', 'Monaco', monospace;
            font-size: 14px;
            overflow: auto;
            border-top: 1px solid #444;
            white-space: pre-wrap;
            word-break: break-all;
        }
        iframe {
            width: 100%;
            height: 100%;
            border: none;
            display: block;
        }
        
        /* Buttons */
        #btn-bar {
            position: absolute;
            top: 10px;
            left: 10px;
            display: flex;
            gap: 8px;
            z-index: 10;
        }
        .overlay-btn {
            background: rgba(32, 32, 32, 0.9);
            color: white;
            border: 1px solid #666;
            border-radius: 4px;
            padding: 8px 16px;
            font-size: 14px;
            cursor: pointer;
        }
        .overlay-btn:hover { background: rgba(64, 64, 64, 0.95); }
        .overlay-btn:active { background: rgba(80, 80, 80, 1); }

    </style>
</head>
<body>
    <!-- Top Pane: Canvas + Controls -->
    <div id="top-pane">
        <div id="btn-bar">
            <button id="mutateBtn" class="overlay-btn">Mutate</button>
            <button id="growBtn" class="overlay-btn">Grow</button>
            <button id="playPauseBtn" class="overlay-btn">Play</button>
        </div>
        <canvas id="canvas"></canvas>
    </div>

    <!-- Middle Pane: Tree Visualizer -->
    <div id="tree-pane"></div>

    <!-- Bottom Pane: Code -->
    <div id="code-pane"></div>

    <script src="function_trees.js"></script>
    <script src="visualizer.js"></script>
    <script>
        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d');
        const treePane = document.getElementById('tree-pane');
        const codePane = document.getElementById('code-pane');

        // Initialize function: x -> y
        let fn = new TreeFunction(["x"], ["y"]);
        fn.mutate();

        // Create Visualizer Iframe
        const iframe = TreeVisualizer.createIframe(fn.trees['y'], { height: '100%' });
        treePane.appendChild(iframe);

        // Viewport state
        let xMin = -5;
        let xMax = 5;
        let yMin = -5;
        let yMax = 5;

        let isPanning = false;
        let panStart = { x: 0, y: 0 };
        let panStartView = { xMin, xMax, yMin, yMax };

        // Auto-mutation state
        let isPlaying = false;
        let mutationInterval = null;

        function updateUI() {
            // Draw Graph
            draw();
            // Update Tree View
            TreeVisualizer.updateIframe(iframe, fn.trees['y']);
            // Update Code View
            codePane.textContent = `y = ${fn.trees['y'].getRawJS()}`;
        }

        function resize() {
            // We need to sync canvas resolution to display size
            canvas.width = canvas.clientWidth;
            canvas.height = canvas.clientHeight;
            draw();
        }

        function draw() {
            const width = canvas.width;
            const height = canvas.height;
            const xRange = xMax - xMin;
            const yRange = yMax - yMin;
            
            ctx.fillStyle = 'black';
            ctx.fillRect(0, 0, width, height);

            // Draw axes
            const xZeroPos = ((0 - xMin) / xRange) * width;
            const yZeroPos = ((yMax - 0) / yRange) * height;

            ctx.strokeStyle = '#333';
            ctx.lineWidth = 1;

            if (yZeroPos >= 0 && yZeroPos <= height) {
                ctx.beginPath(); ctx.moveTo(0, yZeroPos); ctx.lineTo(width, yZeroPos); ctx.stroke();
            }
            if (xZeroPos >= 0 && xZeroPos <= width) {
                ctx.beginPath(); ctx.moveTo(xZeroPos, 0); ctx.lineTo(xZeroPos, height); ctx.stroke();
            }

            // Draw function curve
            ctx.strokeStyle = '#0f0';
            ctx.lineWidth = 2;
            ctx.beginPath();

            const steps = 1000;
            let started = false;

            for (let i = 0; i <= steps; i++) {
                const wx = xMin + (i / steps) * xRange;
                const result = fn.eval({x: wx});
                const wy = result.y;

                if (!isFinite(wy)) {
                    started = false;
                    continue;
                }

                const px = ((wx - xMin) / xRange) * width;
                const py = ((yMax - wy) / yRange) * height;

                if (!started) {
                    ctx.moveTo(px, py);
                    started = true;
                } else {
                    ctx.lineTo(px, py);
                }
            }
            ctx.stroke();
        }

        function togglePlayPause() {
            isPlaying = !isPlaying;
            const playPauseBtn = document.getElementById('playPauseBtn');
            
            if (isPlaying) {
                playPauseBtn.textContent = 'Pause';
                mutationInterval = setInterval(() => {
                    fn.mutate();
                    updateUI();
                }, 200); // Slower interval to see tree updates
            } else {
                playPauseBtn.textContent = 'Play';
                if (mutationInterval) {
                    clearInterval(mutationInterval);
                    mutationInterval = null;
                }
            }
        }

        // Interaction Handlers
        canvas.addEventListener('wheel', (e) => {
            e.preventDefault();
            const rect = canvas.getBoundingClientRect();
            const width = canvas.width;
            const height = canvas.height;
            const mouseX = e.clientX - rect.left;
            const mouseY = e.clientY - rect.top;
            
            const xRange = xMax - xMin;
            const yRange = yMax - yMin;
            
            const worldX = xMin + (mouseX / width) * xRange;
            const worldY = yMax - (mouseY / height) * yRange;
            
            const zoomFactor = e.deltaY > 0 ? 1.1 : 0.9;
            
            xMin = worldX - (worldX - xMin) * zoomFactor;
            xMax = worldX + (xMax - worldX) * zoomFactor;
            yMin = worldY - (worldY - yMin) * zoomFactor;
            yMax = worldY + (yMax - worldY) * zoomFactor;
            
            draw();
        });

        canvas.addEventListener('mousedown', (e) => {
            isPanning = true;
            panStart.x = e.clientX;
            panStart.y = e.clientY;
            panStartView = { xMin, xMax, yMin, yMax };
            canvas.style.cursor = 'grabbing';
        });

        window.addEventListener('mousemove', (e) => {
            if (!isPanning) return;
            const width = canvas.width;
            const height = canvas.height;
            const dx = e.clientX - panStart.x;
            const dy = e.clientY - panStart.y;
            
            const xRange = panStartView.xMax - panStartView.xMin;
            const yRange = panStartView.yMax - panStartView.yMin;
            
            const worldDx = -(dx / width) * xRange;
            const worldDy = (dy / height) * yRange;
            
            xMin = panStartView.xMin + worldDx;
            xMax = panStartView.xMax + worldDx;
            yMin = panStartView.yMin + worldDy;
            yMax = panStartView.yMax + worldDy;
            
            draw();
        });

        window.addEventListener('mouseup', () => {
            isPanning = false;
            canvas.style.cursor = 'grab';
        });

        document.getElementById('mutateBtn').addEventListener('click', () => {
            fn.mutate();
            updateUI();
        });

        document.getElementById('growBtn').addEventListener('click', () => {
            fn.trees['y'].grow();
            updateUI();
        });

        document.getElementById('playPauseBtn').addEventListener('click', togglePlayPause);

        window.addEventListener('resize', resize);
        
        // Initial setup
        resize();
        updateUI();

    </script>
</body>
</html>
